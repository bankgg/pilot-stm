<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PILOT MEMORY TEST EXAMPLE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- BOOTSTRAP CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- JQUERY -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- BOOTSTRAP JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>

  <style>
    /* FORCE ALL TEXT ON THE PAGE TO BE UPPERCASE */
    body {
      text-transform: uppercase;
    }
    .page-section {
      display: none;
    }
    .active-section {
      display: block;
    }
    .timer-container {
      display: none; /* Toggled by SHOW/HIDE TIMER button */
      margin-top: 1rem;
    }
    .timer-display {
      font-weight: bold;
      font-size: 1.5rem;
      width: 80px;
      text-align: center;
    }
  </style>
</head>

<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-4">PILOT SHORT-TERM MEMORY TEST</h1>

  <div class="mb-3">
    <!-- NAV BUTTONS TO SWITCH SUB-PAGES + REGENERATE + TOGGLE TIMER -->
    <button class="btn btn-primary" id="showPassageBtn">PASSAGE</button>
    <button class="btn btn-primary" id="showQuestionsBtn">QUESTIONS</button>
    <button class="btn btn-primary" id="showAnswersBtn">ANSWERS</button>
    <button class="btn btn-success" id="regenerateBtn">REGENERATE TEST</button>
    <button class="btn btn-warning" id="toggleTimerBtn">SHOW/HIDE TIMER</button>
  </div>

  <!-- TIMER SECTION -->
  <div class="timer-container bg-white p-3 border rounded">
    <div class="d-flex align-items-center">
      <div class="me-3">TIMER:</div>
      <div class="timer-display me-3" id="timerDisplay">03:00</div>
      <button class="btn btn-danger" id="toggleStartStopBtn">START TIMER</button>
    </div>
  </div>

  <!-- PASSAGE SECTION -->
  <div class="page-section active-section" id="passageSection">
    <!-- Content generated dynamically by JavaScript -->
  </div>

  <!-- QUESTIONS SECTION -->
  <div class="page-section" id="questionsSection">
    <!-- Questions generated by JavaScript -->
  </div>

  <!-- ANSWERS SECTION -->
  <div class="page-section" id="answersSection">
    <!-- Answers generated by JavaScript -->
  </div>
</div>

<script>
/* 
  CODE FEATURES:
  1. 3-4 LEGS => 2-3 INTERMEDIATE STOPS
  2. PASSENGER CHANGES HAPPEN AT LEAST 2 STOPS, AND UP TO ALL STOPS
  3. STILL 2-3 CLASSES (ECON, BUSINESS, FIRST) SELECTED RANDOMLY
  4. SINGLE-PAGE W/ 3 SUB-PAGES + TIMER
*/

/* --------------------------
   ARRAYS & RANDOM FUNCTIONS
-------------------------- */

// 1) FLIGHT LEVELS: FL250 to FL410 (step 10)
const flightLevels = [
  "FL 250","FL 260","FL 270","FL 280","FL 290","FL 300",
  "FL 310","FL 320","FL 330","FL 340","FL 350","FL 360",
  "FL 370","FL 380","FL 390","FL 400","FL 410"
];

// 2) AIRCRAFT REGISTRATIONS (30+)
const registrations = [
  "HS-TLK","HS-XYZ","VH-OJQ","N123AB","D-ABCD","G-BAJV","F-GHJK",
  "9V-SKP","B-16703","JA8999","9M-MRD","ZK-OKF","OE-LAX","CX-BKT",
  "A4O-BC","SP-LKA","TC-JFE","PK-GII","VT-ESP","A6-EDZ","EC-LPQ",
  "I-BIXP","PR-GTG","PP-VRA","S2-ADF","4R-ALK","SU-GCC","JA734A",
  "B-2956","HL-7615","PT-MVA","YL-LCA","T7-ABC","VQ-BSK"
];

// 3) RANDOM FLIGHT NUMBER = CARRIER + 3–4 DIGITS
const carriers = [
  "TG","QF","CA","BA","AF","LH","EK","SQ","CX","UA","DL","JL","GA",
  "MH","NZ","AK","EY","QR","KL","IB","AZ","SU","AA","AC","AI"
];
function randomFlightNumber() {
  const carrier = randElem(carriers);
  const length = randInt(3,4);
  let digits = "";
  for (let i=0; i<length; i++){
    digits += randInt(0,9);
  }
  return carrier + " " + digits;
}

// 4) 30+ CITIES
const cities = [
  "HONG KONG","SINGAPORE","SYDNEY","FRANKFURT","DUBAI","BANGKOK",
  "ATHENS","TOKYO","NEW DELHI","ROME","JAKARTA","PARIS","LONDON",
  "LOS ANGELES","NEW YORK","AUCKLAND","SHANGHAI","SEOUL","BEIJING",
  "TORONTO","SAN FRANCISCO","CHICAGO","HANOI","KUALA LUMPUR","MANILA",
  "AMSTERDAM","ZURICH","MUMBAI","CAIRO","RIO DE JANEIRO","JOHANNESBURG",
  "ISTANBUL","DOHA","OSAKA","DENPASAR","MOSCOW"
];

// 5) RANDOM RUNWAY 01–36
const runwayNumbers = Array.from({length:36}, (_, i) => (i+1).toString().padStart(2,"0"));

// Misc
const aircraftTypes = [
  "AIRBUS 330-300","AIRBUS 340-300","AIRBUS 300-600","AIRBUS 380",
  "BOEING 747-400","BOEING 777-300","BOEING 787-9","AIRBUS A350-900"
];
const altitudeIntercepts = [2500,3000,3500,4000,4500,5000];
const headings = [250,260,270,280,290,300,310,320];

// Helper randoms
function randElem(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}
function randInt(min, max) {
  return Math.floor(Math.random()*(max-min+1)) + min;
}
function shuffleArr(arr) {
  for (let i=arr.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function randomFlightTime() {
  const hrs = randInt(1,7);
  const mins = randInt(0,59).toString().padStart(2,"0");
  return `${hrs}:${mins}`;
}

/* 
   Generate test data:
   1) 2 or 3 classes from [ECONOMY, BUSINESS, FIRST]
   2) 3–4 legs => 2 or 3 intermediate stops
   3) Among the intermediate stops, pick at least 2 stops, up to all, that have passenger changes. 
      Others have zero changes.
*/
function generateTestData() {
  // Pick 2 or 3 classes
  const possibleClasses = ["ECONOMY","BUSINESS","FIRST"];
  shuffleArr(possibleClasses);
  const numClasses = randInt(2,3);
  const chosenClasses = possibleClasses.slice(0, numClasses);

  // Assign random total passenger counts to chosen classes
  const passengerTotals = { ECONOMY:"N/A", BUSINESS:"N/A", FIRST:"N/A" };
  chosenClasses.forEach(cls => {
    switch(cls){
      case "ECONOMY":
        passengerTotals.ECONOMY = randInt(50, 500); break;
      case "BUSINESS":
        passengerTotals.BUSINESS = randInt(5, 200); break;
      case "FIRST":
        passengerTotals.FIRST = randInt(2, 40); break;
    }
  });

  // 3-4 legs
  const numLegs = randInt(3,4);
  const routeSet = new Set();
  while (routeSet.size < numLegs+1) {
    routeSet.add(randElem(cities));
  }
  const routeCities = [...routeSet];
  
  // flight times
  const times = [];
  for (let i=0; i<numLegs; i++){
    times.push(randomFlightTime());
  }

  // How many intermediate stops => numLegs-1
  // We must ensure at least 2 stops have changes, up to "intermediateCount" stops
  const intermediateCount = numLegs - 1; 
  // If intermediateCount <=2, we have no choice: all must have changes
  // If intermediateCount=3, pick either 2 or 3 stops to have changes
  let stopsToChange = intermediateCount;
  if (intermediateCount === 3) {
    stopsToChange = randInt(2,3); 
  }
  // Randomly choose which stops among the intermediate stops have changes
  // For convenience, create an array [0,1,2,...] representing the stops
  const indices = Array.from({length:intermediateCount}, (_,i) => i);
  shuffleArr(indices);
  const chosenStopIndices = indices.slice(0, stopsToChange); // these stops get random changes

  // Build passengerChanges array with length=intermediateCount
  // Each element is an object { ECONOMY:{off,on}, BUSINESS:..., FIRST:...} or zeros if not chosen
  const passengerChanges = [];
  for (let i=0; i<intermediateCount; i++){
    // If i not in chosenStopIndices => off=on=0 for all chosen classes
    const hasChanges = chosenStopIndices.includes(i);
    const changesObj = {};
    if (chosenClasses.includes("ECONOMY")) {
      changesObj.ECONOMY = { off:0, on:0 };
      if (hasChanges) {
        const maxOff = Math.floor(passengerTotals.ECONOMY/4);
        changesObj.ECONOMY.off = randInt(0, maxOff);
        changesObj.ECONOMY.on = randInt(0,60);
      }
    }
    if (chosenClasses.includes("BUSINESS")) {
      changesObj.BUSINESS = { off:0, on:0 };
      if (hasChanges) {
        const maxOff = Math.floor(passengerTotals.BUSINESS/4);
        changesObj.BUSINESS.off = randInt(0, maxOff);
        changesObj.BUSINESS.on = randInt(0,30);
      }
    }
    if (chosenClasses.includes("FIRST")) {
      changesObj.FIRST = { off:0, on:0 };
      if (hasChanges) {
        const maxOff = Math.floor(passengerTotals.FIRST/4);
        changesObj.FIRST.off = randInt(0, maxOff);
        changesObj.FIRST.on = randInt(0,10);
      }
    }
    passengerChanges.push(changesObj);
  }

  return {
    flightNumber: randomFlightNumber(),
    registration: randElem(registrations),
    aircraftType: randElem(aircraftTypes),
    numLegs,
    routeCities,
    times,
    classes: chosenClasses,
    passengers: passengerTotals,
    passengerChanges,
    crew: randInt(8,18),
    runwayDep: randElem(runwayNumbers),
    runwayArr: randElem(runwayNumbers),
    flightLevel: randElem(flightLevels),
    interceptAltitude: randElem(altitudeIntercepts),
    heading: randElem(headings)
  };
}

/* Build the passage text in the sample style. */
function buildPassage(data) {
  const departure = data.routeCities[0];
  const finalCity = data.routeCities[data.routeCities.length - 1];
  const intermediateStops = data.routeCities.slice(1, data.routeCities.length - 1);

  // Build flight time lines
  let timeDescription = "";
  for (let i=0; i<data.numLegs; i++){
    const start = data.routeCities[i];
    const end = data.routeCities[i+1];
    timeDescription += `FROM ${start} TO ${end} IS ${data.times[i]} HOURS, `;
  }
  timeDescription = timeDescription.slice(0,-2);

  // Mention total passengers only for the classes that exist
  let passengerTotalsDesc = "";
  if (data.classes.includes("ECONOMY")) {
    passengerTotalsDesc += `${data.passengers.ECONOMY} PASSENGERS IN ECONOMY, `;
  }
  if (data.classes.includes("BUSINESS")) {
    passengerTotalsDesc += `${data.passengers.BUSINESS} IN BUSINESS CLASS, `;
  }
  if (data.classes.includes("FIRST")) {
    passengerTotalsDesc += `${data.passengers.FIRST} IN FIRST CLASS, `;
  }
  passengerTotalsDesc = passengerTotalsDesc.slice(0,-2);

  // Crew change at the last intermediate stop
  const crewChangeCity = data.routeCities[data.routeCities.length - 2] || finalCity;

  // Build lines describing passenger on/off at each stop
  let passengerChangeDesc = "";
  for (let i=0; i<intermediateStops.length; i++){
    const stopCity = intermediateStops[i];
    const changesObj = data.passengerChanges[i];
    // If all off/on are zero => means no changes
    const lines = [];
    if (data.classes.includes("ECONOMY")) {
      const econ = changesObj.ECONOMY;
      if (econ.off>0 || econ.on>0) {
        lines.push(`${econ.off} PASSENGERS IN ECONOMY GET OFF AND ${econ.on} GET ON`);
      }
    }
    if (data.classes.includes("BUSINESS")) {
      const biz = changesObj.BUSINESS;
      if (biz.off>0 || biz.on>0) {
        lines.push(`${biz.off} IN BUSINESS CLASS GET OFF AND ${biz.on} GET ON`);
      }
    }
    if (data.classes.includes("FIRST")) {
      const fst = changesObj.FIRST;
      if (fst.off>0 || fst.on>0) {
        lines.push(`${fst.off} IN FIRST CLASS GET OFF AND ${fst.on} GET ON`);
      }
    }

    if (lines.length>0) {
      passengerChangeDesc += `AFTER ARRIVAL AT ${stopCity}, ${lines.join(", ")}. `;
    } else {
      passengerChangeDesc += `AFTER ARRIVAL AT ${stopCity}, NO PASSENGERS GET ON OR OFF. `;
    }
  }

  return `
    <h2>MEMORY - 3 MINUTES</h2>
    <p>
      THIS IS FLIGHT ${data.flightNumber} REGISTRATION NUMBER ${data.registration}. 
      TYPE OF THE AIRCRAFT IS ${data.aircraftType}, FROM ${departure} TO ${finalCity}. 
      BETWEEN ROUTE, THIS FLIGHT WILL MAKE LANDINGS FOR CHANGING PASSENGERS, AIR CREWS AND REFUELING. 
      THEY ARE ${intermediateStops.join(", ")}. 
      ${timeDescription}. 
      THEY ARE ${passengerTotalsDesc}. 
      ON THE CABIN ${data.crew} AIRCREWS ARE WORKING UNTIL ${crewChangeCity}, THEN IT WILL CHANGE ALL AIRCREWS THERE. 
      ${passengerChangeDesc}
      FOR DEPARTURE IN ${departure} THE PILOTS USED RUNWAY ${data.runwayDep} FOR TAKE OFF. 
      WHEN REACHING ${data.interceptAltitude} FEET THEY ARE VECTORED TO TURN RIGHT HEADING ${data.heading} 
      FOR INTERCEPT THE AIRWAY AND THEY ARE CLEARED FOR CLIMBING TO MAINTAIN ${data.flightLevel} FOR FINAL LEVEL.
    </p>
  `;
}


/* QUESTION POOL (unchanged from previous logic). */
const questionPool = [
  {
    text: "WHAT IS THE FLIGHT NUMBER?",
    answer: d => d.flightNumber
  },
  {
    text: "WHAT IS THE REGISTRATION NUMBER?",
    answer: d => d.registration
  },
  {
    text: "WHAT IS THE TYPE OF AIRCRAFT?",
    answer: d => d.aircraftType
  },
  {
    text: "HOW MANY CABIN CREWS ARE ON BOARD?",
    answer: d => d.crew
  },
  {
    text: "HOW MANY PASSENGERS IN ECONOMY CLASS?",
    answer: d => d.classes.includes("ECONOMY") ? d.passengers.ECONOMY : "N/A"
  },
  {
    text: "HOW MANY PASSENGERS IN BUSINESS CLASS?",
    answer: d => d.classes.includes("BUSINESS") ? d.passengers.BUSINESS : "N/A"
  },
  {
    text: "HOW MANY PASSENGERS IN FIRST CLASS?",
    answer: d => d.classes.includes("FIRST") ? d.passengers.FIRST : "N/A"
  },
  {
    text: "WHERE DID THE FLIGHT DEPART FROM?",
    answer: d => d.routeCities[0]
  },
  {
    text: "WHAT IS THE FINAL DESTINATION?",
    answer: d => d.routeCities[d.routeCities.length - 1]
  },
  {
    text: "HOW MANY TOTAL FLIGHT LEGS DOES THIS TRIP HAVE?",
    answer: d => d.numLegs
  },
  {
    text: "NAME ALL THE INTERMEDIATE STOPOVERS IN ORDER.",
    answer: d => d.routeCities.slice(1, d.routeCities.length-1).join(", ")
  },
  {
    text: "WHICH AIRPORT DOES THE CREW CHANGE OCCUR?",
    answer: d => d.routeCities[d.routeCities.length - 2]
  },
  {
    text: "HOW LONG IS THE FLIGHT TIME FOR THE FIRST LEG?",
    answer: d => `${d.times[0]} HOURS`
  },
  {
    text: "WHAT IS THE RUNWAY USED FOR TAKE OFF?",
    answer: d => d.runwayDep
  },
  {
    text: "WHAT IS THE FINAL CRUISE LEVEL?",
    answer: d => d.flightLevel
  },
  {
    text: "HOW HIGH ARE THEY WHEN VECTORED TO TURN RIGHT?",
    answer: d => `${d.interceptAltitude} FEET`
  },
  {
    text: "WHAT HEADING WERE THEY GIVEN TO INTERCEPT THE AIRWAY?",
    answer: d => `${d.heading}`
  },
  {
    text: "HOW MANY PASSENGERS GET OFF IN ECONOMY CLASS AT THE FIRST STOP?",
    answer: d => {
      if (!d.classes.includes("ECONOMY")) return "N/A";
      return d.numLegs > 1 ? d.passengerChanges[0].ECONOMY.off : "N/A";
    }
  },
  {
    text: "HOW MANY PASSENGERS GET ON IN BUSINESS CLASS AT THE SECOND STOP?",
    answer: d => {
      if (!d.classes.includes("BUSINESS")) return "N/A";
      return d.numLegs > 2 ? d.passengerChanges[1].BUSINESS.on : "N/A";
    }
  },
  {
    text: "HOW MANY PASSENGERS GET OFF IN FIRST CLASS AT THE LAST INTERMEDIATE STOP?",
    answer: d => {
      if (!d.classes.includes("FIRST")) return "N/A";
      const i = d.numLegs - 2;
      return i>=0 ? d.passengerChanges[i].FIRST.off : "N/A";
    }
  },
  {
    text: "LIST THE ENTIRE ROUTE (DEPARTURE TO FINAL).",
    answer: d => d.routeCities.join(" - ")
  },
  {
    text: "HOW LONG IS THE FINAL LEG?",
    answer: d => `${d.times[d.numLegs - 1]} HOURS`
  },
  {
    text: "HOW MANY PASSENGERS IN TOTAL?",
    answer: d => {
      let sum = 0;
      if (d.classes.includes("ECONOMY")) sum += d.passengers.ECONOMY;
      if (d.classes.includes("BUSINESS")) sum += d.passengers.BUSINESS;
      if (d.classes.includes("FIRST")) sum += d.passengers.FIRST;
      return sum === 0 ? "N/A" : sum;
    }
  },
];

// Shuffle question pool and pick 10
function pickQuestions(data, count=10) {
  const copy = [...questionPool];
  shuffleArr(copy);
  const selected = copy.slice(0,count);
  return selected.map((q,idx) => ({
    number: idx+1,
    text: q.text,
    answer: q.answer(data)
  }));
}

function buildQuestionsHTML(questions) {
  let html = `<h2>QUESTIONS OF THE MEMORY PART</h2><ol>`;
  questions.forEach(q => {
    html += `<li>${q.text}</li>`;
  });
  html += `</ol>`;
  return html;
}
function buildAnswersHTML(questions) {
  let html = `<h2>ANSWERS</h2><ol>`;
  questions.forEach(q => {
    html += `<li>${q.answer}</li>`;
  });
  html += `</ol>`;
  return html;
}

/* --------------------------
   TIMER & PAGE BEHAVIOR
-------------------------- */
let timeLeft = 180; 
let timerInterval = null; 
let timerRunning = false;

function updateTimerDisplay() {
  const min = Math.floor(timeLeft / 60);
  const sec = timeLeft % 60;
  const minStr = min.toString().padStart(2, "0");
  const secStr = sec.toString().padStart(2, "0");
  $("#timerDisplay").text(`${minStr}:${secStr}`);
}

function startTimer() {
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    if (timeLeft <= 0) {
      stopTimer();
      timeLeft = 0;
      updateTimerDisplay();
    }
  }, 1000);
}

function stopTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = null;
}

function toggleStartStopTimer() {
  if (!timerRunning) {
    timerRunning = true;
    $("#toggleStartStopBtn").text("STOP TIMER");
    // If time is 0 or 180, reset
    if (timeLeft === 0 || timeLeft === 180) {
      timeLeft = 180;
      updateTimerDisplay();
    }
    startTimer();
  } else {
    timerRunning = false;
    $("#toggleStartStopBtn").text("START TIMER");
    stopTimer();
  }
}

function showSection(sectionId) {
  $(".page-section").removeClass("active-section");
  $(`#${sectionId}`).addClass("active-section");
}

$(document).ready(function(){
  let currentQuestions = [];

  function generateAll() {
    const data = generateTestData();
    // Build passage
    $("#passageSection").html(buildPassage(data));
    // Build Q&A
    currentQuestions = pickQuestions(data, 10);
    $("#questionsSection").html(buildQuestionsHTML(currentQuestions));
    $("#answersSection").html(buildAnswersHTML(currentQuestions));
  }

  // Initial generation
  generateAll();

  // Button actions
  $("#showPassageBtn").click(() => showSection("passageSection"));
  $("#showQuestionsBtn").click(() => showSection("questionsSection"));
  $("#showAnswersBtn").click(() => showSection("answersSection"));

  $("#regenerateBtn").click(() => generateAll());

  $("#toggleTimerBtn").click(() => $(".timer-container").toggle());

  $("#toggleStartStopBtn").click(() => toggleStartStopTimer());

  // Initialize timer
  updateTimerDisplay();
});
</script>

</body>
</html>